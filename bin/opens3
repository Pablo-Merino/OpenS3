#!/usr/bin/env ruby

require 'rubygems'
require 'rack'
require 'opens3'
require 'trollop'

opts = Trollop::options do
  opt :dir,    "OpenS3 storage directory", :short => '-d', :type => :string
  opt :port,   "OpenS3 server port",       :short => '-p', :type => :int
  opt :config, "Config file",              :short => '-c', :type => :string
  opt :token,  "Set token string",         :short => '-t', :type => :string
end

if opts[:dir] and opts[:port] and opts[:token] and !opts[:config]
  @port  = opts[:port]
  @dir   = opts[:dir]
  @token = opts[:token]

elsif !opts[:dir] and !opts[:token] and !opts[:port] and opts[:config]
  unless !File.exists?(opts[:config])
    cfg = YAML::load(File.open(opts[:config]))
    @port  = cfg['port']
    @dir   = cfg['dir']
    @token = cfg['token']
  end
end

if @port and @dir and @token
  Rack::Handler::Thin.run OpenS3.app(@dir,@token), :Port => @port.to_i
else
  puts "No port/directory/token or config file specified"
end
